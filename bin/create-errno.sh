#! /bin/sh

# Generates the contents of the file code/unix-errno.lisp.  The args
# to this script, if supplied, must be a list of files containing the
# definitions of all the Unix errno values.
#

# Where the output should go.
OUTPUT="src/code/errno.lisp"

# Template file containing the default def-unix-error forms and other
# support code.
TEMPLATE="bin/errno-template.lisp"

# Set ERRNO_FILES to the files where we can find errno definitions.
case `uname -s` in
    Linux) ERRNO_FILES=/usr/include/asm-generic/errno*.h
	   ;;
    Darwin) ERRNO_FILES=/usr/include/sys/errno.h
	    ;;
    SunOS) ERRNO_FILES=/usr/include/sys/errno.h
	   ;;
esac

if [ -z "$ERRNO_FILES" ]; then
    # Copy the main errno template to the output.  The template is a lisp
    # file so we can read and modify it more easily.
    cat "$TEMPLATE" > $OUTPUT
else
    # We can autogenerate the def-unix-error forms.  Copy just the
    # initial part of the template, up to the first def-unix-error
    # form.
    sed '/^(def-unix-error ESUCCESS/q' "$TEMPLATE" > $OUTPUT
    cat >> $OUTPUT <<EOF

;; Autogenerated def-unix-error forms
EOF
    
    # Create appropriate DEF-UNIX-ERROR forms by reading header files
    # containing the C definitions.

    awk -f bin/create-def-unix-error.awk ${ERRNO_FILES} >> $OUTPUT

    # The tail was also copied from code/unix.lisp.  It's needed to tell
    # Lisp about the errno values.
    sed '1,/^;;; End of default/d' "$TEMPLATE" >> $OUTPUT
fi


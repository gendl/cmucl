#! /bin/sh

# Generates the contents of the file code/unix-errno.lisp.  The args
# to this script, if supplied, must be a list of files containing the
# definitions of all the Unix errno values.
#

usage ()
{
    cat <<EOF
create-erno.sh [-h?DS]
    -h    This help
    -?    This help
    -D	  Do not auto-generate; use default

    -S    Show the resulting generated file; the file is still created.

Auto-generates, if possible, the file src/code/errno.lisp that
contains the def-unix-error forms.
EOF
    exit 0
}

while getopts "h?DS" arg
do
    case $arg in
	h) usage ;;
	\?) usage ;;
	D) DEFAULT=yes ;;
	S) SHOW=yes ;;
    esac
done

# Where the output should go.
ERRNO_FILE="src/code/errno.lisp"

# Template file containing the default def-unix-error forms and other
# support code.
TEMPLATE="bin/errno-template.lisp"

# Set ERRNO_FILES to the files where we can find errno definitions.
if [ -z "$DEFAULT" ]; then
    case $(uname -s) in
	Linux) ERRNO_FILES=/usr/include/asm-generic/errno*.h
	       ;;
	Darwin) ERRNO_FILES=/usr/include/sys/errno.h
		;;
	SunOS) ERRNO_FILES=/usr/include/sys/errno.h
	       ;;
    esac
fi

if [ -z "$ERRNO_FILES" ]; then
    # Copy the main errno template to the output.  The template is a lisp
    # file so we can read and modify it more easily.
    cat "$TEMPLATE" > $ERRNO_FILE
else
    # We can autogenerate the def-unix-error forms.  Copy just the
    # initial part of the template, up to the first def-unix-error
    # form.
    {
	sed '/^(def-unix-error ESUCCESS/q' "$TEMPLATE"
	cat <<EOF

;; Autogenerated def-unix-error forms
EOF
	
	# Create appropriate DEF-UNIX-ERROR forms by reading header files
	# containing the C definitions.

	awk -f bin/create-def-unix-error.awk ${ERRNO_FILES}

	# The tail was also copied from code/unix.lisp.  It's needed to tell
	# Lisp about the errno values.
	sed '1,/^;;; End of default/d' "$TEMPLATE"
    } > $ERRNO_FILE
fi

# If -S option given, cat the output file to stdout
if [ -n "$SHOW" ]; then
    cat $ERRNO_FILE
fi

# Now generate the defpackage form for the ERRNO package.
{
    cat  <<EOF
;;; -*- Log: C.Log -*-
;;;
;;; **********************************************************************
;;; This code was written as part of the CMU Common Lisp project at
;;; Carnegie Mellon University, and has been placed in the public domain.
;;;
(ext:file-comment
  ": src/code/exports-errno.lisp $")
;;;
;;; **********************************************************************
;;;
;;; Defines the ERRNO package and all the exported symbols.
;;;
;;; This file is auto-generated via bin/create-errno.sh.
;;;
;;; DO NOT EDIT!
;;;

(in-package "LISP")

(intl:textdomain "cmucl")

(if (find-package "ERRNO")
    (rename-package "ERRNO" "ERRNO" 'nil)
    (make-package "ERRNO" :nicknames 'nil :use nil))

(defpackage "ERRNO"
  (:export
EOF
    # Get the def-unix-error forms from the ERRNO_FILE, extract out
    # the name, put double-quotes around them and then sort the result
    # to get all the exported symbols for the ERRNO package.
    grep '(def-unix-error ' $ERRNO_FILE |
	cut -d ' ' -f2 |
	sed 's/\(.*\)/   "\1"/' |
	sort
    # Close the defpackage form
    cat <<EOF
   ))
EOF
} > src/code/exports-errno.lisp
